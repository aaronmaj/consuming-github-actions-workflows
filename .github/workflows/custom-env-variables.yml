name: Custom Environment Variables

on:
  workflow_dispatch:
    inputs:
      app:
        description: 'App to deploy'
        required: true
        type: choice
        options:
          - banking-api
          - banking-ui
          - banking-mobile
      deploy-env:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

env:
  API_VERSION_DEV: 1.0.0
  UI_VERSION_DEV: 2.0.0
  MOBILE_VERSION_DEV: 3.0.0

  API_VERSION_TEST: 0.0.9
  UI_VERSION_TEST: 1.9.0
  MOBILE_VERSION_TEST: 2.0.0

  API_VERSION_PROD: 0.0.7
  UI_VERSION_PROD: 1.0.0
  MOBILE_VERSION_PROD: 2.0.0

  API_ENDPOINT_URL: https://api.banking.com/v1
  UI_ENDPOINT_URL: https://ui.banking.com/v1
  MOBILE_ENDPOINT_URL: https://mobile.banking.com/v1

jobs:
  init-envs:
    runs-on: ubuntu-latest
    outputs:
      app-version: ${{ steps.set-vars.outputs.app-version }}
      deploy-env: ${{ steps.set-vars.outputs.deploy-env }}
      dockerhub-username: ${{ steps.set-vars.outputs.dockerhub-username }}
      azure_publish_profile: ${{ steps.set-vars.AZURE_PUBLISH_PROFILE }}
    steps:
      - name: Set environment variables
        id: set-vars
        shell: bash
        run: |
          # Map app names to prefixes
          
#          case "${{ github.event.inputs.app }}" in
#            banking-api)    APP_PREFIX="API" ;;
#            banking-ui)     APP_PREFIX="UI" ;;
#            banking-mobile) APP_PREFIX="MOBILE" ;;
#          esac
          
          declare -A APP_PREFIX_MAP=(
            ["banking-api"]="API"
            ["banking-ui"]="UI"
            ["banking-mobile"]="MOBILE"
          )
          declare -A APP_VERSION_MAP=(
            ["banking-api"]="${{ env.API_VERSION_DEV }}"
            ["banking-ui"]="${{ env.UI_VERSION_DEV }}"
            ["banking-mobile"]="${{ env.MOBILE_VERSION_DEV }}"
          )
          declare -A APP_ENDPOINT_URL_MAP=(
            ["banking-api"]="${{ env.API_ENDPOINT_URL }}"
            ["banking-ui"]="${{ env.UI_ENDPOINT_URL }}"
            ["banking-mobile"]="${{ env.MOBILE_ENDPOINT_URL }}"
          )
          
          # Map environment to suffix
          ENV_SUFFIX=$(echo "${{ github.event.inputs.deploy-env }}" | tr '[:lower:]' '[:upper:]')
          
          # Construct variable name and get value
          VERSION_VAR="${APP_PREFIX_MAP[${{ github.event.inputs.app }}]}_VERSION_${ENV_SUFFIX}"
          APP_VERSION=$(eval echo "\$${VERSION_VAR}")
          
          # Display values for debugging
          echo "App version is $APP_VERSION"
          echo "App prefix is ${APP_PREFIX_MAP[${{ github.event.inputs.app }}]}"
          echo "App endpoint URL is ${APP_ENDPOINT_URL_MAP[${{ github.event.inputs.app }}]}"
          echo "Deploy environment is ${{ github.event.inputs.deploy-env }}"
          
          app="${{ github.event.inputs.app }}"
          
          if [[ -z "${APP_VERSION_MAP[$app]}" ]]; then
            echo "Invalid app name: $app"
            exit 1
          fi
          
          # Set outputs
          echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "app-prefix=$(printenv ${APP_PREFIX_MAP[$app]})" >> $GITHUB_OUTPUT
          echo "app-endpoint-url=$(printenv ${APP_ENDPOINT_URL_MAP[$app]})" >> $GITHUB_OUTPUT
          echo "deploy-env=${{ github.event.inputs.deploy-env }}" >> $GITHUB_OUTPUT
          echo "dockerhub-username=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_OUTPUT
          echo "azure_publish_profile=${{ secrets.AZURE_PUBLISH_PROFILE }}">> $GITHUB_OUTPUT

      - name: Display initialized values
        run: |
          echo "Selected App: ${{ github.event.inputs.app }}"
          echo "App Version: ${{ steps.set-vars.outputs.app-version }}"
          echo "Deploy Environment: ${{ steps.set-vars.outputs.deploy-env }}"
          echo "DockerHub Username: ${{ steps.set-vars.outputs.dockerhub-username }}"
          echo "Azure Publish Profile: ${{ steps.set-vars.outputs.azure_publish_profile }}"

  build:
    runs-on: ubuntu-latest
    needs: init-envs
    steps:
      - name: Display environment values
        run: |
          echo "App: ${{ github.event.inputs.app }}"
          echo "APP_VERSION: ${{ needs.init-envs.outputs.app-version }}"
          echo "APP_PREFIX: ${{ needs.init-envs.outputs.app-prefix }}"
          echo "APP_ENDPOINT_URL: ${{ needs.init-envs.outputs.app-endpoint-url }}"
          echo "DEPLOY_ENV: ${{ needs.init-envs.outputs.deploy-env }}"
          echo "DOCKERHUB_USERNAME: ${{ needs.init-envs.outputs.dockerhub-username }}"
          echo "AZURE_PUBLISH_PROFILE: ${{ needs.init-envs.outputs.azure_publish_profile }}"

      - name: Set local environment variable
        run: echo "VAR_1=value set from first step" >> $GITHUB_ENV

      - name: Display local variable
        run: echo "Value of VAR_1 is $VAR_1"

      - name: Set color output
        id: color-selector
        run: echo "SELECTED_COLOR=blue" >> $GITHUB_OUTPUT

      - name: Get color output
        env:
          SELECTED_COLOR: ${{ steps.color-selector.outputs.SELECTED_COLOR }}
        run: echo "The selected color is $SELECTED_COLOR"

      - name: Build application
        env:
          APP_VERSION: ${{ needs.init-envs.outputs.app-version }}
          DEPLOY_ENV: ${{ needs.init-envs.outputs.deploy-env }}
        run: |
          echo "Building ${{ github.event.inputs.app }} version $APP_VERSION for $DEPLOY_ENV environment"
          # Add your actual build commands here